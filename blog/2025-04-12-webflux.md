---
slug: webflux
title: T·ªïng h·ª£p ki·∫øn th·ª©c Spring WebFlux
authors: [ducbq1]
tags: [webflux, spring]
---
# üìå T·ªïng h·ª£p ki·∫øn th·ª©c Spring WebFlux

## 1. Gi·ªõi thi·ªáu WebFlux

- **Spring WebFlux** l√† m·ªôt module c·ªßa Spring 5 cho ph√©p x√¢y d·ª±ng ·ª©ng d·ª•ng web theo m√¥ h√¨nh l·∫≠p tr√¨nh **Reactive (b·∫•t ƒë·ªìng b·ªô - kh√¥ng ch·∫∑n)**.
- D·ª±a tr√™n th∆∞ vi·ªán **Project Reactor** v·ªõi 2 lo·∫°i ch√≠nh:
  - `Mono<T>`: ƒë·∫°i di·ªán cho 0 ho·∫∑c 1 ph·∫ßn t·ª≠.
  - `Flux<T>`: ƒë·∫°i di·ªán cho 0 ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠.

## 2. M·ªôt s·ªë h√†m th∆∞·ªùng d√πng trong WebFlux

| H√†m                 | M√¥ t·∫£                                                                       |
| -------------------- | ----------------------------------------------------------------------------- |
| `.map()`           | Bi·∫øn ƒë·ªïi d·ªØ li·ªáu ƒë·∫ßu v√†o th√†nh ƒë·∫ßu ra kh√°c (gi·ªëng stream map).   |
| `.flatMap()`       | Tr·∫£ v·ªÅ `Mono`/`Flux` kh√°c b√™n trong (d√πng khi g·ªçi b·∫•t ƒë·ªìng b·ªô). |
| `.filter()`        | L·ªçc d·ªØ li·ªáu d·ª±a tr√™n ƒëi·ªÅu ki·ªán.                                       |
| `.switchIfEmpty()` | Thay th·∫ø gi√° tr·ªã khi kh√¥ng c√≥ d·ªØ li·ªáu (Mono.empty ho·∫∑c Flux.empty).   |
| `.onErrorResume()` | X·ª≠ l√Ω l·ªói, tr·∫£ fallback value ho·∫∑c logic thay th·∫ø.                      |
| `.doOnNext()`      | Ch·∫°y logic ph·ª• (logging, debug...) khi c√≥ ph·∫ßn t·ª≠ ƒëi qua.               |
| `.then()`          | Khi `Mono<Void>`, ti·∫øp t·ª•c chu·ªói x·ª≠ l√Ω kh√¥ng quan t√¢m k·∫øt qu·∫£.     |
| `.collectList()`   | Bi·∫øn `Flux<T>` th√†nh `Mono<List<T>>`.                                   |
| `.block()`         | Bi·∫øn `Mono/Flux` th√†nh x·ª≠ l√Ω ƒë·ªìng b·ªô (ch·∫∑n lu·ªìng - n√™n tr√°nh).   |

## 3. G·ªçi HTTP trong WebFlux (HTTP Client)

### D√πng `WebClient`:

```java
@Autowired
private WebClient.Builder webClientBuilder;

public Mono<ResponseDTO> callApi() {
    return webClientBuilder.build()
        .get()
        .uri("https://api.example.com/data")
        .retrieve()
        .bodyToMono(ResponseDTO.class);
}
```

## 4. G·ªçi h√†m reactive trong h√†m blocking

‚úÖ C√≥ th·ªÉ, nh∆∞ng:

- Kh√¥ng n√™n **g·ªçi `Mono/Flux.block()` trong context c·ªßa WebFlux**, v√¨ n√≥ **ch·∫∑n** lu·ªìng, l√†m m·∫•t ƒëi b·∫£n ch·∫•t **non-blocking**.
- N·∫øu b·∫Øt bu·ªôc d√πng, h√£y ch·∫Øc ch·∫Øn g·ªçi t·ª´ thread kh√¥ng thu·ªôc event loop.

```java
public String handle() {
    Mono<String> mono = webClient.get().retrieve().bodyToMono(String.class);
    return mono.block(); // ‚ùå Kh√¥ng khuy·∫øn kh√≠ch trong WebFlux Controller
}
```

## 5. G·ªçi HTTP client trong controller kh√¥ng reactive

‚úÖ C√≥ th·ªÉ d√πng `RestTemplate` ho·∫∑c `HttpClient` trong controller th∆∞·ªùng (Spring MVC).

```java
@RestController
public class MyController {
    private final RestTemplate restTemplate = new RestTemplate();

    @GetMapping("/call")
    public ResponseEntity<String> call() {
        String result = restTemplate.getForObject("https://api.example.com", String.class);
        return ResponseEntity.ok(result);
    }
}
```

## 6. Chuy·ªÉn Mono, Flux sang Blocking

- D√πng `.block()` ho·∫∑c `.toStream()` (v·ªõi Flux):

```java
Mono<String> mono = Mono.just("hello");
String result = mono.block(); // Chuy·ªÉn sang sync

Flux<String> flux = Flux.just("a", "b", "c");
List<String> list = flux.collectList().block(); // Chuy·ªÉn sang list
```

> ‚ö†Ô∏è **L∆∞u √Ω**: `.block()` **ch·ªâ n√™n d√πng ·ªü t·∫ßng service ho·∫∑c ngo√†i context WebFlux** nh∆∞ trong unit test, console app, batch job...

## 7. C√°c v√≠ d·ª• th∆∞·ªùng d√πng

### 1. `map()` ‚Äì Bi·∫øn ƒë·ªïi d·ªØ li·ªáu ƒë∆°n gi·∫£n

```java
@GetMapping("/hello")
public Mono<String> hello() {
    return Mono.just("webflux")
               .map(s -> s.toUpperCase()); // K·∫øt qu·∫£: "WEBFLUX"
}
```

---

### 2. `flatMap()` ‚Äì D√πng cho thao t√°c b·∫•t ƒë·ªìng b·ªô (nested Mono)

```java
@GetMapping("/userinfo")
public Mono<String> userInfo() {
    return Mono.just("123")
               .flatMap(userId -> webClient.get()
                                           .uri("/api/users/" + userId)
                                           .retrieve()
                                           .bodyToMono(String.class));
}
```

---

### 3. `filter()` ‚Äì L·ªçc d·ªØ li·ªáu

```java
@GetMapping("/numbers")
public Flux<Integer> evenNumbers() {
    return Flux.range(1, 10)
               .filter(n -> n % 2 == 0); // Ch·ªâ l·∫•y s·ªë ch·∫µn
}
```

---

### 4. `zip()` ‚Äì K·∫øt h·ª£p nhi·ªÅu Mono/Flux

```java
@GetMapping("/user/details")
public Mono<String> getUserDetails() {
    Mono<String> nameMono = Mono.just("Alice");
    Mono<Integer> ageMono = Mono.just(25);

    return Mono.zip(nameMono, ageMono)
               .map(tuple -> "Name: " + tuple.getT1() + ", Age: " + tuple.getT2());
}
```

---

### 5. `onErrorResume()` ‚Äì X·ª≠ l√Ω l·ªói v√† fallback

```java
@GetMapping("/product")
public Mono<String> getProduct() {
    return webClient.get()
                    .uri("/api/products/999")
                    .retrieve()
                    .bodyToMono(String.class)
                    .onErrorResume(e -> Mono.just("S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i"));
}
```

---

### 6. `doOnNext()` ‚Äì Th·ª±c hi·ªán h√†nh ƒë·ªông ph·ª• (side-effect)

```java
@GetMapping("/log")
public Mono<String> logData() {
    return Mono.just("WebFlux log")
               .doOnNext(data -> System.out.println("Log: " + data));
}
```

---

### 7. `collectList()` ‚Äì T·ª´ Flux ‚Üí List (ƒë√≥ng g√≥i l·∫°i)

```java
@GetMapping("/flux-to-list")
public Mono<List<Integer>> getList() {
    return Flux.range(1, 5)
               .collectList(); // Mono<List<Integer>> = [1, 2, 3, 4, 5]
}
```

---

### 8. `switchIfEmpty()` ‚Äì Tr·∫£ gi√° tr·ªã n·∫øu Mono/Flux r·ªóng

```java
@GetMapping("/fallback")
public Mono<String> fallbackDemo() {
    return Mono.empty()
               .switchIfEmpty(Mono.just("Gi√° tr·ªã m·∫∑c ƒë·ªãnh"));
}
```

---

### 9. `delayElements()` ‚Äì M√¥ ph·ªèng stream d·ªØ li·ªáu

```java
@GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> streamData() {
    return Flux.just("A", "B", "C")
               .delayElements(Duration.ofSeconds(1)); // G·ª≠i t·ª´ng ph·∫ßn t·ª≠ m·ªói gi√¢y
}
```
